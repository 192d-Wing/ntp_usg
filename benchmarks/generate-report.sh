#!/bin/bash
# Generate benchmark report from results
#
# Usage: ./generate-report.sh > REPORT.md

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RESULTS_DIR="$SCRIPT_DIR/results"

cat << 'EOF'
# NTP Benchmark Results

**Generated**: $(date +"%Y-%m-%d %H:%M:%S %Z")
**Test Platform**: See test environment details below

---

## Executive Summary

This report contains benchmark results comparing ntp_usg, chrony, and ntpd.

EOF

# Test environment
cat << EOF
## Test Environment

**Hardware**:
- Platform: $(uname -m)
- Kernel: $(uname -r)
- CPU: $(lscpu | grep "Model name" | sed 's/Model name: *//')
- Memory: $(free -h | awk '/^Mem:/{print $2}')

**Software**:
- ntp_usg: $(cd "$SCRIPT_DIR/.." && git describe --tags 2>/dev/null || echo "unknown")
- chrony: $(chronyd --version 2>&1 | head -1 || echo "not installed")
- ntpd: $(ntpd --version 2>&1 | grep -oP 'ntpd \K[0-9.]+' || echo "not installed")

---

EOF

# Client accuracy results
if ls "$RESULTS_DIR"/client-accuracy-*.csv >/dev/null 2>&1; then
  echo "## Client Accuracy"
  echo ""
  python3 "$SCRIPT_DIR/analyze.py" "$RESULTS_DIR"/client-accuracy-*.csv --type client
  echo ""
  echo "---"
  echo ""
fi

# Server throughput results
if ls "$RESULTS_DIR"/server-throughput-*.csv >/dev/null 2>&1; then
  echo "## Server Throughput"
  echo ""
  python3 "$SCRIPT_DIR/analyze.py" "$RESULTS_DIR"/server-throughput-*.csv --type throughput
  echo ""
  echo "---"
  echo ""
fi

# Resource usage results
if ls "$RESULTS_DIR"/resources-*.csv >/dev/null 2>&1; then
  echo "## Resource Usage"
  echo ""
  python3 "$SCRIPT_DIR/analyze.py" "$RESULTS_DIR"/resources-*.csv --type resources
  echo ""
  echo "---"
  echo ""
fi

# Stratum 1 results
if ls "$RESULTS_DIR"/stratum1-*.csv >/dev/null 2>&1; then
  echo "## Stratum 1 Accuracy (GPS+PPS)"
  echo ""
  python3 "$SCRIPT_DIR/analyze.py" "$RESULTS_DIR"/stratum1-*.csv --type stratum1
  echo ""
  echo "---"
  echo ""
fi

# Conclusion
cat << 'EOF'
## Conclusion

See [BENCHMARKS.md](../docs/BENCHMARKS.md) for methodology and detailed analysis.

Raw data available in: `benchmarks/results/`

---

**Report generated by**: `benchmarks/generate-report.sh`
EOF
